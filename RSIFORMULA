=BYROW(A2:A,LAMBDA(r,ARRAYFORMULA(LET(string,"select Col1, Col5 limit 99",ostr,"OFFSET 1",data,GoogleFinance(r,"ALL", TODAY()-150, TODAY()),idx,INDEX(query(sort(data,1,0),string,1),,2),idxOff,INDEX(query(sort(data,1,0),string&ostr,0),,2),condition,IFERROR(idx-idxOff),sortData,SORT(QUERY(SPLIT(QUERY(IF(condition >0,( condition&",0"),("0,"&-condition)),"Select * "),","),"Select *"&ostr) ,ROW(B4:B102),FALSE),selectDataG,CHOOSECOLS(sortData,1),selectDataL,CHOOSECOLS(sortData,2),avgG,SUM(CHOOSEROWS(selectDataG,SEQUENCE(15)))/14,avgL,SUM(CHOOSEROWS(selectDataL,SEQUENCE(15)))/14,IF(r="","", 100-(100/(1+(INDEX(VSTACK(avgG, Scan(avgG,CHOOSEROWS(selectDataG,SEQUENCE(83,1,17,1)),LAMBDA(acc,cval,(acc*13+cval)/14))),84,1)/ INDEX(VSTACK(avgL, Scan(avgL,CHOOSEROWS(selectDataL,SEQUENCE(83,1,17,1)),LAMBDA(acc,cval,(acc*13+cval)/14))),84,1)))))))))
